# 主从数据路由
### 1. 实现方案：
继承接口：org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource
参数：对应需要调用的数据库名称
### 2. 实现原理
#### 2.1 数据的注入- spring的配置注入
```xml
<bean id="dynamicDataSource" class="com.qunar.qa.mock.dynamiccon.DynamicDataSource">
        <property name="targetDataSources">
            <map key-type="java.lang.String">
                <!-- write -->
                <entry key="master" value-ref="dataSourceRw"/>
                <!-- read -->
                <entry key="slave" value-ref="dataSourceR"/>
            </map>
        </property>
        <!-- <property name="defaultTargetDataSource" ref="dataSourceRw"/>-->
    </bean>
```
#### 2.2 数据的获取与切换
线程上下问中的look key:
```java
 public static final ThreadLocal<String> holder = new ThreadLocal<String>();
 holder.set(name);
```
dataSource动态切换
```java
protected DataSource determineTargetDataSource() {
		Assert.notNull(this.resolvedDataSources, "DataSource router not initialized");
		Object lookupKey = determineCurrentLookupKey();
		DataSource dataSource = this.resolvedDataSources.get(lookupKey);
		if (dataSource == null && (this.lenientFallback || lookupKey == null)) {
			dataSource = this.resolvedDefaultDataSource;
		}
		if (dataSource == null) {
			throw new IllegalStateException("Cannot determine target DataSource for lookup key [" + lookupKey + "]");
		}
		return dataSource;
	}
```
DataSource关键-connection
```java
@Override
	public Connection getConnection() throws SQLException {
		return determineTargetDataSource().getConnection();
	}

	@Override
	public Connection getConnection(String username, String password) throws SQLException {
		return determineTargetDataSource().getConnection(username, password);
	}
```