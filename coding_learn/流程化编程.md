# 流程化编程

### 本质

利用编译期对类的加载编一定的流程，流程固化

### 1.初始化流程 - 加载阶段
#### 1.1 使用静态方法，在编译阶段进行固化
```java

public class Stepfactory {

    private static final List<Step> beforeSteps = new LinkedList<>();

    private static final List<Step> afterSteps = new LinkedList<>();

    static {




        beforeSteps.add(new StartStep());

        beforeSteps.add(new EnvCheckStep());

        beforeSteps.add(new MatcherCacheStep());

        beforeSteps.add(new GetMockInfoStep());

        beforeSteps.add(new CheckResultStep());

        beforeSteps.add(new DealSleepStep());

        beforeSteps.add(new DealExceptionStep());

        beforeSteps.add(new DealJsonResultStep());




        afterSteps.add(new AfterEnvCheckStep());

        afterSteps.add(new CollectFilterStep());

        afterSteps.add(new CollectStep());

    }
}

```
#### 1.2 使用Spring的加载连带（注入后初始化）
```java
 @PostConstruct
    public void initDddConfig(){
        loadPluginConfig();
        logger.info("初始化PluginConfig配置完成, bizProductModuleMap={}", JacksonSupport.toJson(bizProductModuleMap));
        loadAbilityConfig();
        logger.info("初始化AbilityConfig配置完成, abilityStrategyMap={}", JacksonSupport.toJson(bizProductModuleMap));
    }
```
#### 1.3 使用Spring的注入加载器进行加载文件
```xml
<bean id="orderRefundStateMachineConfig" class="com.qunar.statemachine.core.FlowStateMachineConfig">
        <constructor-arg name="machineKey" value="orderRefund"/>
        <constructor-arg name="definitionFile" value="classpath:stm/order-refund.xml"/>
        <constructor-arg name="flowContextFactory" ref="orderRefundFlowContextFactory"/>
    </bean>
```
```java
 public FlowStateMachineConfig(String machineKey, String definitionFile, FlowDefinitionFactory flowDefinitionFactory, FlowContextFactory<T, F> flowContextFactory, FlowStoreManager flowStoreManager, int actionReExecuteThreadCount) {
        this.machineKey = machineKey;
        this.definitionFile = definitionFile;
        this.flowDefinitionFactory = flowDefinitionFactory;
        this.flowContextFactory = flowContextFactory;
        this.actionRetryThreadCount = actionReExecuteThreadCount;
        this.flowStoreManager = flowStoreManager;
    }
```



### 2.流程化
#### 2.1 流程化调用并组织先后顺序 - 抽象类

```java

public abstract class Step {

    protected static final Logger logger = LoggerFactory.getLogger(Step.class);




    public abstract String getStepName();




    public abstract void beforeStep(MockContext mockContext);




    public abstract void execStep(MockContext mockContext);




    public abstract void afterStep(MockContext mockContext);




    public void flowStep(MockContext mockContext){

        addStepLog();

        beforeStep(mockContext);

        execStep(mockContext);

        afterStep(mockContext);

    }




    public void addStepLog(){

        logger.debug(getStepName());

    }

}

```

#### 2.2 使用xml(必要的时候需要写xsd控制可编写的内容)
```xml
<?xml version="1.0" encoding="UTF-8"?>


<plugin>
    <business type='common'>
        <product type='express' module='fuwu_module_expressfee'/>
    </business>
</plugin>
```

